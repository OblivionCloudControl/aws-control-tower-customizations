stages:
  - build
  - deploy

image: python:3.9
before_script:
  - pip install pipenv
  - pipenv install

platform:
  stage: build
  script:
    - pipenv run aws cloudformation deploy deployment/custom-control-tower-buckets.cfn.yml
  only:
    refs:
      - master
    changes:
      - deployment/custom-control-tower-buckets.cfn.yml
  artifacts:
    paths:
      - deployment/

build:
  stage: build
  script:
    - bash deployment/substitute-vars.sh
    - pipenv run cfn-lint
    - pipenv run ./deployment/build-s3-dist.sh

deploy:
  stage: deploy
  only:
    - master
  script:
    - pipenv run aws cloudformation deploy s3://custom-control-tower-templates/custom-control-tower-initiation.template # TODO finish command
